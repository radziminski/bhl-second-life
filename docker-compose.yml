version: '3'
services:
    router:
        restart: always
        build:
            dockerfile: Dockerfile
            context: ./router
        depends_on:
            - nest-api
        ports:
            - 80:80
    postgres:
        restart: unless-stopped
        image: postgres:latest
        environment:
            - POSTGRES_PASSWORD=${PG_PASSWORD}
        volumes:
            - ./postgres/data:/var/lib/postgresql/data
            - ./postgres/queries:/docker-entrypoint-initdb.d/
        ports:
            - 5432:5432
    pgadmin:
        image: dpage/pgadmin4
        links:
            - postgres
        depends_on:
            - postgres
        environment:
            - PGADMIN_DEFAULT_EMAIL=${PGADMIN_DEFAULT_EMAIL}
            - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_DEFAULT_PASSWORD}
        ports:
            - '${PGADMIN_PORT}:80'
        restart: unless-stopped
    nest-api:
        restart: unless-stopped
        build:
            dockerfile: Dockerfile.dev
            context: './nest-api'
        volumes:
            - /app/node_modules
            - ./nest-api:/app
        environment:
            - PG_USER=${PG_USER}
            - PG_PASSWORD=${PG_PASSWORD}
            - PG_HOST=${PG_HOST}
            - PG_PORT=${PG_PORT}
            - PG_DATABASE=${PG_DATABASE}
            - API_PORT=${NEST_API_PORT}
            - CHOKIDAR_USEPOLLING=true
    spring-api:
        restart: unless-stopped
        build:
            dockerfile: Dockerfile.dev
            context: './spring-api'
        environment:
            - PG_USER=${PG_USER}
            - PG_PASSWORD=${PG_PASSWORD}
            - PG_HOST=${PG_HOST}
            - PG_PORT=${PG_PORT}
            - PG_DATABASE=${PG_DATABASE}
            - API_PORT=${NEST_API_PORT}
            - CHOKIDAR_USEPOLLING=true
